# Shopping-User 模块重构说明

## 变更概述

本次重构将 shopping-user 模块从原有的手机号+密码登录方式改造为支持微信小程序登录的用户管理模块，移除了不相关的业务代码，专注于小程序用户管理功能。

## 主要变更内容

### 1. 删除的文件

- `People.java` - 不相关的接口
- `Student.java` - 不相关的实体类
- `Teacher.java` - 不相关的实体类

### 2. 新增的文件

#### DTO/VO 类

- `WxUserInfo.java` - 微信用户信息
- `WxLoginRequest.java` - 微信登录请求参数
- `UserProfileVO.java` - 用户信息视图对象
- `LoginResponse.java` - 登录响应对象
- `UserProfileUpdateRequest.java` - 用户信息更新请求

#### Service 类

- `WxLoginService.java` - 微信登录服务，负责通过 code 获取 openId

#### 文档

- `API文档.md` - 接口使用说明
- `数据库迁移.sql` - 数据库变更脚本
- `项目变更说明.md` - 本文档

### 3. 修改的文件

#### User.java (实体类)

**新增字段：**

- `openId` - 微信 openId
- `gender` - 性别
- `city` - 城市
- `province` - 省份
- `country` - 国家
- `points` - 积分
- `coupons` - 优惠券数量
- `balance` - 余额

**新增方法：**

- `wxLogin()` - 微信登录/注册方法

#### UserMapper.java & users_sqlmap.xml

**新增方法：**

- `findByOpenId(String openId)` - 根据 openId 查询用户

**更新：**

- ResultMap 中新增微信相关字段映射

#### UserService.java

**新增方法：**

- `findByOpenId(String openId)` - 通过 openId 查询用户
- `wxLogin(...)` - 微信登录业务逻辑
- `updateProfile(...)` - 更新用户资料

**注入：**

- `WxLoginService` - 微信登录服务

#### UserController.java

**完全重写，新增接口：**

- `POST /user/login` - 微信登录
- `GET /user/profile` - 获取用户信息
- `PUT /user/profile` - 更新用户信息
- `POST /user/logout` - 用户登出

**移除接口：**

- `/getUserInfo`
- `/queryUserByTel`
- `/modifyNickName`
- `/modifyPassword`

#### application.yml

**新增配置：**

```yaml
wx:
  appid: your-wx-appid
  secret: your-wx-secret
```

## 技术实现细节

### 1. 微信登录流程

```
小程序 -> wx.login() -> 获取code
  |
  v
发送code到后端 -> /user/login
  |
  v
WxLoginService.getOpenId(code) -> 调用微信API
  |
  v
根据openId查询/创建用户
  |
  v
生成token并返回
```

### 2. 缓存策略

- 使用 JetCache 对用户信息进行缓存
- 缓存 key 格式：`:user:cache:id:{userId}`
- 缓存有效期：2 小时
- 用户信息更新时自动清除缓存

### 3. 认证授权

- 使用 Sa-Token 进行认证授权
- 登录时调用 `StpUtil.login(userId)` 创建会话
- 登出时调用 `StpUtil.logout()` 清除会话
- 其他接口通过 `StpUtil.getLoginId()` 获取当前登录用户 ID

## 数据库变更

需要执行 `数据库迁移.sql` 脚本，添加以下字段：

```sql
ALTER TABLE users ADD COLUMN open_id VARCHAR(128);
ALTER TABLE users ADD COLUMN gender INT DEFAULT 0;
ALTER TABLE users ADD COLUMN city VARCHAR(100);
ALTER TABLE users ADD COLUMN province VARCHAR(100);
ALTER TABLE users ADD COLUMN country VARCHAR(100);
ALTER TABLE users ADD COLUMN points INT DEFAULT 0;
ALTER TABLE users ADD COLUMN coupons INT DEFAULT 0;
ALTER TABLE users ADD COLUMN balance DOUBLE DEFAULT 0.0;
CREATE INDEX idx_open_id ON users(open_id);
```

## 配置说明

### 必须配置项

1. **微信小程序配置**

   - 在 `application.yml` 中配置 `wx.appid` 和 `wx.secret`
   - 这两个值需要从微信公众平台获取

2. **数据库配置**
   - 执行数据库迁移脚本
   - 确保 users 表有足够的权限进行 ALTER TABLE 操作

### 可选配置项

- Sa-Token 相关配置（如 token 有效期等）
- Redis 缓存配置
- OkHttp 连接池配置

## 测试说明

### 保留的测试文件

- `UserBaseTest.java` - 基础测试类
- `UserDAOTest.java` - DAO 层测试
- `UserServiceTest.java` - Service 层测试

这些测试文件仍然有效，测试了 UserService 的核心功能（注册、认证、激活等），虽然 Controller 层已重写为小程序登录，但 Service 层的大部分功能仍然保留。

### 新增功能测试建议

建议为新增的微信登录功能编写集成测试：

1. 模拟微信登录流程
2. 测试用户信息的获取和更新
3. 测试登出功能
4. 测试异常情况处理

## 兼容性说明

### 保留的功能

以下功能仍然保留，以供后续可能的需求：

- 手机号+密码注册和登录（Service 层方法保留）
- 用户认证（实名认证）
- 用户激活
- 用户冻结/解冻
- 邀请码机制
- 邀请排行榜

### 移除的功能

- 基于手机号的 Controller 接口（已被微信登录替代）
- 密码修改接口（小程序登录不需要密码）

## 后续优化建议

1. **安全性增强**

   - 添加请求频率限制
   - 添加敏感操作的二次验证

2. **性能优化**

   - 考虑使用布隆过滤器防止缓存穿透
   - 优化数据库查询

3. **功能扩展**

   - 添加用户等级系统
   - 添加积分兑换功能
   - 添加优惠券管理

4. **监控告警**
   - 添加登录失败次数监控
   - 添加接口调用量监控

## 联系方式

如有问题，请联系开发团队。

---

**变更日期**: 2025-10-14  
**变更人**: wangjin  
**版本**: 1.0.0
